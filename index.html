<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELT Map - Social Enterprise Legislative Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Frank+Ruhl+Libre:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #00abce 0%, #73a535 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .grunin-branding {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .grunin-logo-img {
            width: 180px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            padding: 15px;
        }

        .grunin-title {
            text-align: left;
        }

        .grunin-name {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grunin-subtitle {
            font-size: 1em;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            font-family: 'Frank Ruhl Libre', serif;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .controls {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .year-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .year-controls label {
            font-weight: 600;
            color: #925333;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #73a535;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        select:focus {
            outline: none;
            border-color: #00abce;
        }

        .legend {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #925333;
            font-weight: 500;
        }

        .legend-emoji {
            font-size: 16px;
        }

        .map-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 600px;
            margin-bottom: 30px;
        }

        #map {
            height: 100%;
            border-radius: 15px;
            overflow: hidden;
        }

        .content-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .content-section h2 {
            color: #925333;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
        }

        .content-section p {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
            font-family: 'Frank Ruhl Libre', serif;
            font-size: 1.1em;
        }

        .reports-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            max-width: 400px;
        }

        .report-link {
            display: block;
            padding: 15px 20px;
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .report-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #925333, #73a535);
        }

        .acknowledgment {
            background: linear-gradient(135deg, #925333, #73a535);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .acknowledgment h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .acknowledgment p {
            color: rgba(255,255,255,0.95);
            font-style: italic;
        }

        .popup-content {
            font-family: 'Montserrat', sans-serif;
        }

        .popup-content h3 {
            margin-bottom: 10px;
            color: #925333;
            font-weight: 600;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }

        .history-btn {
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: transform 0.2s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .history-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #925333, #73a535);
        }

        .custom-emoji-icon {
            background: none !important;
            border: none !important;
            text-align: center;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #925333, #73a535);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #00abce, #925333);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #73a535, #00abce);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .forms-definitions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-definition {
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #00abce;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-definition:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .form-definition h3 {
            color: #925333;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .form-definition p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0;
            font-family: 'Frank Ruhl Libre', serif;
        }

        .form-definition:nth-child(1) { border-left-color: #00abce; }
        .form-definition:nth-child(2) { border-left-color: #73a535; }
        .form-definition:nth-child(3) { border-left-color: #925333; }
        .form-definition:nth-child(4) { border-left-color: #00abce; }
        .form-definition:nth-child(5) { border-left-color: #73a535; }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .grunin-branding {
                flex-direction: column;
                gap: 15px;
            }

            .grunin-title {
                text-align: center;
            }

            .grunin-logo-img {
                width: 150px;
            }

            .controls {
                flex-direction: column;
                text-align: center;
            }

            .legend {
                justify-content: center;
            }

            .map-container {
                height: 400px;
            }

            .content-section {
                padding: 20px;
            }

            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .forms-definitions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .legend {
                flex-direction: column;
                gap: 10px;
            }

            .legend-item {
                justify-content: center;
            }

            .grunin-name {
                font-size: 1.2em;
            }

            .content-section h2 {
                font-size: 1.5em;
            }

            .stats-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="grunin-branding">
                <img src="gruninlogo.png" alt="Grunin Center Logo" class="grunin-logo-img">
                <div class="grunin-title">
                    <div class="grunin-name">Grunin Center for Law & Social Entrepreneurship</div>
                    <div class="grunin-subtitle">NYU School of Law</div>
                </div>
            </div>
            <h1>Social Enterprise Law Tracker</h1>
        </div>

        <div class="content-section">
            <h2>About</h2>
            <p>Welcome to the Social Enterprise Law Tracker ("SELT"). Beginning in 2008, state legislatures started authorizing a new class of entities collectively known as <em>social enterprises</em>. These corporate and company forms are designed for businesses that seek to create positive social and environmental impacts in addition to financial returns. These forms include the benefit corporation (Benefit Corps), the social purpose corporation (SPC), the low-profit limited liability company (L3C), the benefit limited liability company (BLLC), and the statutory public benefit limited partnership (SPBLP).</p>
            
            <p>The SELT visualizes how social enterprise law has spread across the US. Select any state to see the social enterprise forms that are available, and historic legislative activity.</p>
            
            <p>The SELT was developed by Rob Esposito and Shawn Pelsinger, with support from the NYU Jacobson Leadership Program in Law & Business, the NYU Stern Business & Society Program, and the NYU Law and Social Entrepreneurship Association. The SELT is now hosted and maintained by the Grunin Center for Law and Social Entrepreneurship.</p>
        </div>

        <div class="content-section forms-section">
            <h2>Social Enterprise Corporate Forms Defined</h2>
            <p>The SELT tracks the following five corporate forms, each designed to support businesses pursuing both profit and positive social or environmental impact:</p>
            
            <div class="forms-definitions">
                <div class="form-definition">
                    <h3>Benefit Corporation (BCORP)</h3>
                    <p>The most widely adopted form, requiring companies to pursue general public benefit alongside profit. Directors must consider stakeholder interests beyond shareholders in decision-making.</p>
                </div>
                
                <div class="form-definition">
                    <h3>Social Purpose Corporation (SPC)</h3>
                    <p>Allows corporations to define specific social or environmental purposes in addition to profit maximization. Provides flexibility in how companies balance financial and social objectives.</p>
                </div>
                
                <div class="form-definition">
                    <h3>Low-profit Limited Liability Company (L3C)</h3>
                    <p>Designed primarily for charitable purposes with limited profit distribution. Originally created to facilitate program-related investments (PRIs) by foundations.</p>
                </div>
                
                <div class="form-definition">
                    <h3>Benefit Limited Liability Company (BLLC)</h3>
                    <p>Combines the flexibility of LLC structure with benefit corporation principles. Currently available only in Delaware, offering LLC tax treatment with social benefit requirements.</p>
                </div>
                
                <div class="form-definition">
                    <h3>Social Purpose Benefit Limited Partnership (SPBLP)</h3>
                    <p>A limited partnership structure for social enterprises, particularly suited for impact investing. Also currently available only in Delaware for sophisticated investment arrangements.</p>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="year-controls">
                <label for="yearSelect">Year:</label>
                <select id="yearSelect">
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <span class="legend-emoji">⚪</span>
                    <span>No Activity</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">✅</span>
                    <span>Enacted Form(s)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">❌</span>
                    <span>Failed Legislation</span>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="content-section" id="statsSection">
            <h2 id="statsTitle">2024 Status Summary</h2>
            <div class="stats-summary" id="statsSummary">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <div class="content-section">
            <h2>Annual Reports: The State of Social Enterprise and the Law</h2>
            <p>Every year the Grunin Center for Law and Social Entrepreneurship tracks US legislative developments in the social enterprise field. Click on the links below to access our comprehensive annual reports documenting the evolution of social enterprise legislation across the US from 2009 to the present.</p>
            
            <div class="reports-grid">
                <a href="https://socentlawtracker.org/wp-content/uploads/2024/09/2023_2024_Grunin_Tepper_Social-Enterprise-and-Law-Report.pdf" target="_blank" class="report-link">
                    📊 2023-2024 Report
                </a>
                <a href="https://socentlawtracker.org/wp-content/uploads/2023/09/2022_2023_Grunin_Tepper_Report.pdf" target="_blank" class="report-link">
                    📊 2022-2023 Report
                </a>
                <a href="https://socentlawtracker.org/wp-content/uploads/2022/08/2021-2022_Grunin_Tepper_Report.pdf" target="_blank" class="report-link">
                    📊 2021-2022 Report
                </a>
                <a href="https://www.law.nyu.edu/sites/default/files/Tepper%20Report%20-%20State%20of%20Social%20Enterprise%20and%20the%20Law%20-%202020-2021.pdf" target="_blank" class="report-link">
                    📊 2020-2021 Report
                </a>
                <a href="https://www.law.nyu.edu/sites/default/files/ICBRSSEL21.1%20Grunin%20Tepper%20Report_Web_508v2.pdf" target="_blank" class="report-link">
                    📊 2019-2020 Report
                </a>
                <a href="https://socentlawtracker.org/wp-content/uploads/2019/05/Grunin-Tepper-Report_5_30_B.pdf" target="_blank" class="report-link">
                    📊 2018-2019 Report
                </a>
                <a href="http://www.law.nyu.edu/sites/default/files/upload_documents/Tepper%20Report%20-%20State%20of%20Social%20Enterprise%20and%20the%20Law%20-%202017-2018.pdf" target="_blank" class="report-link">
                    📊 2017-2018 Report
                </a>
            </div>
            
            <div class="acknowledgment">
                <h3>Acknowledgment</h3>
                <p>This research project is generously funded by the Tepper Family. We would like to extend our gratitude to the Tepper Family, with particular thanks to Marvin Tepper '58, Elise Tepper, Jacqueline Tepper '90, Edward Tepper, and Shelley Tepper.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" onload="console.log('Leaflet loaded successfully')" onerror="console.error('Failed to load Leaflet from cdnjs')"></script>
    <script>
        // Fallback Leaflet loading
        function loadLeafletFallback() {
            if (typeof L === 'undefined') {
                console.log('Loading Leaflet fallback...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = () => {
                    console.log('Leaflet fallback loaded successfully');
                    initializeApp();
                };
                script.onerror = () => {
                    console.error('Leaflet fallback also failed to load');
                    document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Map failed to load. Please check your internet connection and refresh the page.</div>';
                };
                document.head.appendChild(script);
            } else {
                console.log('Leaflet already available');
                initializeApp();
            }
        }

        // Data from your CSV files - integrated legislative data
        const legislativeData = {
            "2009": {
                "IL": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] }
            },
            "2010": {
                "IL": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "NC": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "RI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
            },
            "2011": {
                "CA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
                "IL": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "NC": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "RI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "KS": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "HI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NJ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "VA": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
            },
            "2012": {
                "CA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
                "WA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
                "IL": { "forms": ["L3C", "BCORP"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["L3C", "BCORP"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "NC": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "RI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "KS": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "HI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NJ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "VA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "PA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "SC": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
            },
            "2013": {
                "CA": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
                "WA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
                "IL": { "forms": ["L3C", "BCORP"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["L3C", "BCORP"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "NC": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "RI": { "forms": ["L3C", "BCORP"], "failed": [], "rescinded": [] },
                "KS": { "forms": ["L3C"], "failed": [], "rescinded": [] },
                "AR": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "AZ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "CO": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "CT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "DC": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "DE": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "HI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NJ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NV": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "OR": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "PA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "SC": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "VA": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
            },
            "2024": {
                "AL": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "AR": { "forms": ["BCORP"], "failed": ["L3C"], "rescinded": [] },
                "AZ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "CA": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
                "CO": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "CT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "DC": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "DE": { "forms": ["BCORP", "BLLC", "SPBLP"], "failed": [], "rescinded": [] },
                "FL": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
                "GA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "HI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "ID": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "IL": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "IN": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "IA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "KS": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "KY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "LA": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "MA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "ME": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MI": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "MN": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MO": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "MS": { "forms": [], "failed": ["BCORP"], "rescinded": [] },
                "MT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NC": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "ND": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NE": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NH": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NJ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NM": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NV": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "NY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "OH": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "OK": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "OR": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "PA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "RI": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "SC": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "SD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "TN": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "TX": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
                "UT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "VA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "VT": { "forms": ["BCORP", "L3C"], "failed": [], "rescinded": [] },
                "WA": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
                "WI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "WV": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
                "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] }
            }
        };

        // Fill in missing years with progression
        const years = [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024];
        
        // Corporate form definitions
        const corporateForms = {
            "SPC": "Social Purpose Corporation",
            "L3C": "Low-profit Limited Liability Company", 
            "BLLC": "Benefit Limited Liability Company",
            "SPBLP": "Social Purpose Benefit Limited Partnership",
            "BCORP": "Benefit Corporation"
        };

        // State name mappings
        const stateNames = {
            "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California",
            "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "FL": "Florida", "GA": "Georgia",
            "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa",
            "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland",
            "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri",
            "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey",
            "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio",
            "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina",
            "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont",
            "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming",
            "DC": "District of Columbia"
        };

        // Function to get activity status for a state in a given year
        function getStateActivity(stateCode, year) {
            const yearData = legislativeData[year.toString()];
            if (!yearData || !yearData[stateCode]) {
                return { status: "none", emoji: "⚪", forms: [], failed: [], rescinded: [] };
            }
            
            const stateData = yearData[stateCode];
            const formsCount = stateData.forms.length;
            const failedCount = stateData.failed.length;
            const rescindedCount = stateData.rescinded.length;
            
            // Determine status and emoji
            let status, emoji;
            
            if (rescindedCount > 0) {
                status = "rescinded";
                emoji = rescindedCount === 1 ? "⛔" : "⛔⛔";
            } else if (failedCount > 0 && formsCount === 0) {
                status = "failed";
                emoji = "❌";
            } else if (formsCount > 0) {
                status = "enacted";
                if (formsCount === 1) emoji = "✅";
                else if (formsCount === 2) emoji = "✅✅";
                else emoji = "✅✅✅";
            } else {
                status = "none";
                emoji = "⚪";
            }
            
            return {
                status: status,
                emoji: emoji,
                forms: stateData.forms,
                failed: stateData.failed,
                rescinded: stateData.rescinded
            };
        }

        // Function to get all available years
        function getAvailableYears() {
            return years;
        }

        // Main SELT Map class
        class SELTMap {
            constructor() {
                this.currentYear = 2024;
                this.map = null;
                this.stateMarkers = new Map();
                this.init();
            }

            init() {
                this.initializeMap();
                this.setupControls();
                this.createStateMarkers();
                this.updateDisplay();
                this.updateStats();
            }

            initializeMap() {
                this.map = L.map('map', {
                    center: [35.5, -95.7129],
                    zoom: 4.5,
                    minZoom: 4.5,
                    maxZoom: 4.5,
                    zoomControl: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    keyboard: false,
                    dragging: false,
                    touchZoom: false,
                    tap: true
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);
            }

            setupControls() {
                const yearSelect = document.getElementById('yearSelect');
                const years = getAvailableYears();
                
                yearSelect.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === this.currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                });

                yearSelect.addEventListener('change', (e) => {
                    this.currentYear = parseInt(e.target.value);
                    this.updateDisplay();
                    this.updateStats();
                });
            }

            createStateMarkers() {
                const stateCoords = {
                    'CA': [36.7783, -119.4179], 'TX': [31.0545, -97.5635], 'FL': [27.7663, -81.6868],
                    'NY': [42.1657, -74.9481], 'PA': [40.5908, -77.2098], 'IL': [40.3495, -88.9861],
                    'OH': [40.3888, -82.7649], 'GA': [33.0406, -83.6431], 'NC': [35.5557, -79.3877],
                    'MI': [43.3266, -84.5361], 'NJ': [40.2989, -74.5210], 'VA': [37.7693, -78.2057],
                    'WA': [47.0379, -120.8510], 'AZ': [33.7298, -111.4312], 'MA': [42.2373, -71.5314],
                    'TN': [35.7478, -86.7123], 'IN': [39.8647, -86.2604], 'MO': [38.4561, -92.2884],
                    'MD': [39.0639, -76.8021], 'WI': [44.2619, -89.6165], 'CO': [39.0598, -105.3111],
                    'MN': [45.6945, -93.9002], 'SC': [33.8191, -80.9066], 'AL': [32.8067, -86.7911],
                    'LA': [31.1695, -91.8678], 'KY': [37.6681, -84.6701], 'OR': [44.5672, -122.1269],
                    'OK': [35.5653, -96.9289], 'CT': [41.5978, -72.7554], 'UT': [40.1135, -111.8535],
                    'NV': [38.3135, -117.0554], 'AR': [34.9513, -92.3809], 'MS': [32.7673, -89.6812],
                    'KS': [38.5111, -96.8005], 'NM': [34.8375, -106.2371], 'NE': [41.1254, -98.2681],
                    'WV': [38.4680, -80.9696], 'ID': [44.2394, -114.5103], 'HI': [21.0943, -157.4983],
                    'NH': [43.4108, -71.5653], 'ME': [44.6939, -69.3819], 'RI': [41.6762, -71.5562],
                    'MT': [46.9048, -110.3261], 'DE': [39.3185, -75.5071], 'SD': [44.2853, -100.2263],
                    'ND': [47.5362, -99.7930], 'AK': [61.3025, -152.7764], 'VT': [44.0407, -72.7093],
                    'WY': [42.7475, -107.2085], 'DC': [38.9072, -77.0369], 'IA': [42.0115, -93.2105]
                };

                Object.entries(stateCoords).forEach(([stateCode, coords]) => {
                    const marker = L.marker(coords, {
                        icon: this.createCustomIcon("⚪")
                    }).addTo(this.map);

                    this.stateMarkers.set(stateCode, marker);
                });
            }

            createCustomIcon(emoji) {
                return L.divIcon({
                    html: `<div style="font-size: 18px; text-align: center; line-height: 1; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${emoji}</div>`,
                    iconSize: [24, 24],
                    className: 'custom-emoji-icon'
                });
            }

            createPopupContent(stateCode, activity) {
                const stateName = stateNames[stateCode] || stateCode;
                
                let content = `
                    <div class="popup-content">
                        <h3>${stateName} ${activity.emoji}</h3>
                        <p><strong>Year:</strong> ${this.currentYear}</p>
                `;

                if (activity.forms.length > 0) {
                    content += `<p><strong>Enacted Forms:</strong></p>`;
                    content += `<ul>`;
                    activity.forms.forEach(form => {
                        const formName = corporateForms[form] || form;
                        content += `<li><strong>${form}</strong> - ${formName}</li>`;
                    });
                    content += `</ul>`;
                }

                if (activity.failed.length > 0) {
                    content += `<p><strong>Failed Legislation:</strong></p>`;
                    content += `<ul>`;
                    activity.failed.forEach(form => {
                        const formName = corporateForms[form] || form;
                        content += `<li><strong>${form}</strong> - ${formName}</li>`;
                    });
                    content += `</ul>`;
                }

                if (activity.rescinded.length > 0) {
                    content += `<p><strong>Rescinded Forms:</strong></p>`;
                    content += `<ul>`;
                    activity.rescinded.forEach(form => {
                        const formName = corporateForms[form] || form;
                        content += `<li><strong>${form}</strong> - ${formName}</li>`;
                    });
                    content += `</ul>`;
                }

                if (activity.forms.length === 0 && activity.failed.length === 0 && activity.rescinded.length === 0) {
                    content += `<p><em>No legislative activity this year</em></p>`;
                }

                content += `
                        <button onclick="window.open('states/${stateCode.toLowerCase()}.html', '_blank')" 
                                class="history-btn">
                          View Complete Legislative History
                        </button>
                      </div>
                `;

                return content;
            }

            updateDisplay() {
                // Close any open popups when year changes
                this.map.closePopup();
                
                // Update the stats section title
                document.getElementById('statsTitle').textContent = `${this.currentYear} Status Summary`;
                
                this.stateMarkers.forEach((marker, stateCode) => {
                    const activity = getStateActivity(stateCode, this.currentYear);
                    marker.setIcon(this.createCustomIcon(activity.emoji));
                    marker.bindPopup(this.createPopupContent(stateCode, activity));
                });
            }

            updateStats() {
                const yearData = legislativeData[this.currentYear.toString()] || {};
                
                let statesWithForms = 0;
                let totalForms = 0;
                let statesWithFailed = 0;
                let uniqueForms = new Set();

                Object.values(yearData).forEach(stateData => {
                    if (stateData.forms.length > 0) {
                        statesWithForms++;
                        totalForms += stateData.forms.length;
                        stateData.forms.forEach(form => uniqueForms.add(form));
                    }
                    if (stateData.failed.length > 0) {
                        statesWithFailed++;
                    }
                });

                const statsHtml = `
                    <div class="stat-card">
                        <span class="stat-number">${statesWithForms}</span>
                        <span>States with Social Enterprise Forms</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${uniqueForms.size}</span>
                        <span>Unique Form Types Available</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${totalForms}</span>
                        <span>Total Forms Enacted</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${statesWithFailed}</span>
                        <span>States with Failed Legislation</span>
                    </div>
                `;

                document.getElementById('statsSummary').innerHTML = statsHtml;
            }
        }

        // Initialize the application
        function initializeApp() {
            if (typeof L !== 'undefined') {
                new SELTMap();
            } else {
                console.error('Leaflet still not available');
                document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Map library failed to load. Please refresh the page.</div>';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Give Leaflet a moment to load, then check
            setTimeout(() => {
                if (typeof L !== 'undefined') {
                    console.log('Leaflet loaded from primary source');
                    initializeApp();
                } else {
                    console.log('Primary Leaflet load failed, trying fallback...');
                    loadLeafletFallback();
                }
            }, 200);
        });
    </script>
</body>
</html>